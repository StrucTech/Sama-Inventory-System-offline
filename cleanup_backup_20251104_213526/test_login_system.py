"""
Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
"""

import sys
import os

# Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from sheets.users_manager import UsersManager
from config.settings import load_config

def test_users_system():
    """Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†"""
    print("ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...")
    print("=" * 60)
    
    try:
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        config = load_config()
        if not config:
            print("âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª")
            return False
        
        print("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­")
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        users_manager = UsersManager(
            credentials_file=config.get('credentials_file', ''),
            spreadsheet_name=config.get('spreadsheet_name', '')
        )
        
        print("ğŸ“± Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Sheets...")
        
        # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        if not users_manager.connect():
            print("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Sheets")
            return False
        
        print("âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Sheets Ø¨Ù†Ø¬Ø§Ø­")
        
        # Ø§Ø®ØªØ¨Ø§Ø± 1: Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø£Ø¯Ù…Ù† Ø§ÙØªØ±Ø§Ø¶ÙŠ
        print("\nğŸ”§ Ø§Ø®ØªØ¨Ø§Ø± 1: Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ")
        print("-" * 40)
        
        if not users_manager.user_exists("admin"):
            result = users_manager.create_admin_user()
            if result:
                print("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ù†Ø¬Ø§Ø­")
            else:
                print("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¯Ù…Ù†")
        else:
            print("â„¹ï¸ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¯Ù…Ù† Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„")
        
        # Ø§Ø®ØªØ¨Ø§Ø± 2: Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ
        print("\nğŸ‘¤ Ø§Ø®ØªØ¨Ø§Ø± 2: Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ")
        print("-" * 40)
        
        test_username = "test_user"
        test_password = "test123"
        
        if not users_manager.user_exists(test_username):
            result = users_manager.create_user(test_username, test_password, "user")
            if result:
                print(f"âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… '{test_username}' Ø¨Ù†Ø¬Ø§Ø­")
            else:
                print(f"âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… '{test_username}'")
        else:
            print(f"â„¹ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… '{test_username}' Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„")
        
        # Ø§Ø®ØªØ¨Ø§Ø± 3: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        print("\nğŸ” Ø§Ø®ØªØ¨Ø§Ø± 3: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„")
        print("-" * 40)
        
        # Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ØµØ­ÙŠØ­
        user_info = users_manager.authenticate_user("admin", "admin123")
        if user_info:
            print("âœ… Ù†Ø¬Ø­ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†")
            print(f"   ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user_info['username']}")
            print(f"   ğŸ­ Ø§Ù„Ù†ÙˆØ¹: {user_info['user_type']}")
            print(f"   ğŸ“… Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„: {user_info['last_login']}")
        else:
            print("âŒ ÙØ´Ù„ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†")
        
        # Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø®Ø§Ø·Ø¦
        user_info = users_manager.authenticate_user("admin", "wrong_password")
        if user_info:
            print("âŒ ØªÙ… Ù‚Ø¨ÙˆÙ„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!")
        else:
            print("âœ… ØªÙ… Ø±ÙØ¶ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§Ø·Ø¦Ø©")
        
        # Ø§Ø®ØªØ¨Ø§Ø± 4: Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        print("\nğŸ“‹ Ø§Ø®ØªØ¨Ø§Ø± 4: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†")
        print("-" * 40)
        
        users_list = users_manager.get_all_users()
        users_count = users_manager.get_users_count()
        
        print(f"ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {users_count}")
        
        if users_list:
            print("ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:")
            for i, user in enumerate(users_list, 1):
                print(f"   {i}. ğŸ‘¤ {user['username']} ({user['user_type']})")
                print(f"      ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: {user['created_date']}")
                print(f"      ğŸ•’ Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„: {user['last_login'] or 'Ù„Ù… ÙŠØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯'}")
                print(f"      ğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø©: {user['status']}")
                print()
        else:
            print("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…")
        
        # Ø§Ø®ØªØ¨Ø§Ø± 5: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©
        print("\nğŸ” Ø§Ø®ØªØ¨Ø§Ø± 5: ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Google Sheets")
        print("-" * 40)
        
        if users_manager.users_sheet:
            try:
                all_data = users_manager.users_sheet.get_all_values()
                print(f"ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ ÙÙŠ Ø§Ù„Ø´ÙŠØª: {len(all_data)}")
                
                if len(all_data) > 1:  # Ø£ÙƒØ«Ø± Ù…Ù† ØµÙ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
                    print("ğŸ“‹ Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:")
                    headers = all_data[0]
                    print(f"   Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†: {headers}")
                    
                    for i, row in enumerate(all_data[1:3], 1):  # Ø£ÙˆÙ„ ØµÙÙŠÙ† Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        print(f"   Ø§Ù„ØµÙ {i}: {row}")
                else:
                    print("â„¹ï¸ Ø§Ù„Ø´ÙŠØª ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙÙ‚Ø·")
                
            except Exception as e:
                print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´ÙŠØª: {e}")
        
        print("\nğŸ‰ Ø§Ù†ØªÙ‡Ù‰ Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­!")
        return True
        
    except Exception as e:
        print(f"ğŸ’¥ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…: {e}")
        return False

def test_validation():
    """Ø§Ø®ØªØ¨Ø§Ø± ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
    print("\nğŸ”¬ Ø§Ø®ØªØ¨Ø§Ø± ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...")
    print("=" * 60)
    
    try:
        config = load_config()
        users_manager = UsersManager(
            credentials_file=config.get('credentials_file', ''),
            spreadsheet_name=config.get('spreadsheet_name', '')
        )
        
        if not users_manager.connect():
            print("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„")
            return False
        
        # Ø§Ø®ØªØ¨Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©
        test_cases = [
            ("", "password123", "Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… ÙØ§Ø±Øº"),
            ("ab", "password123", "Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ù‚ØµÙŠØ±"),
            ("valid_user", "", "ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ÙØ§Ø±ØºØ©"),
            ("valid_user", "123", "ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ØµÙŠØ±Ø©"),
        ]
        
        print("ğŸš« Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©:")
        for username, password, description in test_cases:
            result = users_manager.create_user(username, password)
            if result:
                print(f"âŒ ØªÙ… Ù‚Ø¨ÙˆÙ„ {description}!")
            else:
                print(f"âœ… ØªÙ… Ø±ÙØ¶ {description}")
        
        return True
        
    except Exception as e:
        print(f"ğŸ’¥ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ­Ù‚Ù‚: {e}")
        return False

def main():
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    print("ğŸš€ Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„")
    print("=" * 80)
    
    # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
    success1 = test_users_system()
    
    # Ø§Ø®ØªØ¨Ø§Ø± ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    success2 = test_validation()
    
    print("\n" + "=" * 80)
    if success1 and success2:
        print("ğŸ‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø¬Ø­Øª!")
        print("\nğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù†:")
        print("   â€¢ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: python main_with_auth.py")
        print("   â€¢ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€: admin / admin123")
        print("   â€¢ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚")
    else:
        print("âŒ Ø¨Ø¹Ø¶ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙØ´Ù„Øª")
    
    print("=" * 80)

if __name__ == "__main__":
    main()
    input("\nØ§Ø¶ØºØ· Enter Ù„Ù„Ø®Ø±ÙˆØ¬...")
