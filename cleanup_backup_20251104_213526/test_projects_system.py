"""
Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ Ù„Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
"""

import os
import sys

# Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from sheets.users_manager import UsersManager
from sheets.projects_manager import ProjectsManager
from sheets.manager import SheetsManager
from config.settings import load_config

def test_projects_system():
    """Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†"""
    
    print("ğŸš€ Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...")
    print("=" * 60)
    
    # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    config = load_config()
    if not config:
        print("âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª")
        return False
    
    credentials_file = config.get("credentials_file", "config/credentials.json")
    spreadsheet_name = config.get("spreadsheet_name", "Inventory Management")
    
    try:
        # 1. Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯
        print("\n1ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¯Ø«...")
        users_manager = UsersManager(credentials_file, spreadsheet_name)
        
        if not users_manager.connect():
            print("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†")
            return False
        
        print("âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­")
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø£Ø¯Ù…Ù† Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        if not users_manager.user_exists("admin"):
            users_manager.create_admin_user()
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ
        test_username = "test_project_user"
        if not users_manager.user_exists(test_username):
            if users_manager.create_user(test_username, "test123", "user"):
                print(f"âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ '{test_username}'")
            else:
                print(f"âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ '{test_username}'")
        
        # 2. Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
        print("\n2ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹...")
        projects_manager = ProjectsManager(credentials_file, spreadsheet_name)
        
        if not projects_manager.connect():
            print("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹")
            return False
        
        print("âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­")
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹ ØªØ¬Ø±ÙŠØ¨ÙŠ
        test_project_name = "Ù…Ø´Ø±ÙˆØ¹ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…"
        project_id = projects_manager.create_project(
            test_project_name, 
            "Ù…Ø´Ø±ÙˆØ¹ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯"
        )
        
        if project_id:
            print(f"âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ Ø¨Ø±Ù‚Ù… '{project_id}'")
        else:
            # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø´Ø±ÙˆØ¹ Ù…ÙˆØ¬ÙˆØ¯
            projects = projects_manager.get_all_projects()
            if projects:
                project_id = projects[0]['project_id']
                print(f"ğŸ”„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø´Ø±ÙˆØ¹ Ù…ÙˆØ¬ÙˆØ¯: '{project_id}'")
            else:
                print("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø´Ø±ÙˆØ¹")
                return False
        
        # 3. Ø§Ø®ØªØ¨Ø§Ø± ØªØ¹ÙŠÙŠÙ† Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù…Ø´Ø±ÙˆØ¹
        print("\n3ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± ØªØ¹ÙŠÙŠÙ† Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù…Ø´Ø±ÙˆØ¹...")
        
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ
        users_without_project = users_manager.get_users_without_project()
        if users_without_project:
            user_to_assign = users_without_project[0]
            user_id = user_to_assign['user_id']
            
            if users_manager.assign_user_to_project(user_id, project_id):
                print(f"âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… '{user_to_assign['username']}' Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ '{project_id}'")
            else:
                print("âŒ ÙØ´Ù„ ÙÙŠ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù…Ø´Ø±ÙˆØ¹")
        else:
            print("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§Ø±ÙŠØ¹ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±")
        
        # 4. Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ø­Ø¯Ø«
        print("\n4ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ø­Ø¯Ø«...")
        sheets_manager = SheetsManager(credentials_file, spreadsheet_name)
        
        if not sheets_manager.connect():
            print("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ†")
            return False
        
        print("âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­")
        
        # Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± ØªØ¬Ø±ÙŠØ¨ÙŠ Ù…Ø±Ø¨ÙˆØ· Ø¨Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
        test_item_name = f"Ø¹Ù†ØµØ± ØªØ¬Ø±ÙŠØ¨ÙŠ - {project_id}"
        if sheets_manager.add_item(test_item_name, 50, project_id):
            print(f"âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± ØªØ¬Ø±ÙŠØ¨ÙŠ '{test_item_name}' Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ '{project_id}'")
        else:
            print("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ")
        
        # Ø§Ø®ØªØ¨Ø§Ø± ÙÙ„ØªØ±Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø­Ø³Ø¨ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
        project_items = sheets_manager.get_items_by_project(project_id)
        print(f"ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ '{project_id}': {len(project_items)}")
        
        # 5. Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
        print("\n5ï¸âƒ£ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…:")
        print(f"ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {users_manager.get_user_count()}")
        print(f"ğŸ“ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹: {projects_manager.get_project_count()}")
        print(f"ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙƒÙ„ÙŠ: {len(sheets_manager.get_all_items())}")
        print(f"ğŸ”— Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ: {len(project_items)}")
        
        # 6. Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
        print("\n6ï¸âƒ£ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…ØªØ§Ø­Ø©:")
        projects = projects_manager.get_all_projects()
        for project in projects:
            print(f"  ğŸ“ {project['project_id']}: {project['name']} ({project['status']})")
        
        # 7. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§Ø±ÙŠØ¹
        print("\n7ï¸âƒ£ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§Ø±ÙŠØ¹:")
        users_without_projects = users_manager.get_users_without_project()
        if users_without_projects:
            for user in users_without_projects:
                print(f"  ğŸ‘¤ {user['user_id']}: {user['username']}")
        else:
            print("  âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…ÙØ¹ÙŠÙÙ‘Ù†ÙˆÙ† Ù„Ù…Ø´Ø§Ø±ÙŠØ¹")
        
        print("\n" + "=" * 60)
        print("ğŸ‰ ØªÙ… Ø§ÙƒØªÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!")
        print("âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†")
        
        return True
        
    except Exception as e:
        print(f"\nâŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: {e}")
        return False

if __name__ == "__main__":
    success = test_projects_system()
    if success:
        print("\nğŸš€ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…:")
        print("   python main_with_auth.py")
        print("\nğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:")
        print("   ğŸ‘¤ Ø§Ù„Ù…Ø¯ÙŠØ±: admin / admin123")
        print("   ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ: test_project_user / test123")
    else:
        print("\nâŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± - ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø§ØªØµØ§Ù„")
    
    input("\nØ§Ø¶ØºØ· Enter Ù„Ù„Ø®Ø±ÙˆØ¬...")