name: Build and Release Sama Inventory System

on:
  push:
    tags:
      - 'v*'  # ÙŠØªÙ… ØªØ´ØºÙŠÙ„Ù‡ Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ tag ÙŠØ¨Ø¯Ø£ Ø¨Ù€ v (Ù…Ø«Ù„ v1.0.0)
  workflow_dispatch:  # ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ù† GitHub Actions

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_build.txt
        
    - name: Check Files Before Build
      run: |
        echo "ğŸ“ Checking project files..."
        dir
        echo "ğŸ” Looking for main file..."
        if (Test-Path "main_with_auth.py") { echo "âœ… main_with_auth.py found" } else { echo "âŒ main_with_auth.py missing" }
        if (Test-Path "requirements_build.txt") { echo "âœ… requirements_build.txt found" } else { echo "âŒ requirements_build.txt missing" }
        if (Test-Path "build_setup.py") { echo "âœ… build_setup.py found" } else { echo "âŒ build_setup.py missing" }
        
    - name: Build Executable
      run: |
        $env:PYTHONIOENCODING="utf-8"
        $env:PYTHONUTF8=1
        python build_setup.py
        
    - name: Check Build Output
      run: |
        echo "Checking build output..."
        if (Test-Path "dist") {
          echo "[OK] dist folder exists"
          echo "Contents of dist folder:"
          Get-ChildItem -Path "dist" | ForEach-Object { echo "  $($_.Name) ($($_.GetType().Name))" }
          echo ""
          echo "All files and folders in dist (recursive):"
          Get-ChildItem -Path "dist" -Recurse | ForEach-Object { echo "  $($_.FullName)" }
        } else {
          echo "[ERROR] dist folder not found!"
          exit 1
        }
        
    - name: Create ZIP Archive
      run: |
        echo "Creating ZIP archive..."
        $distFolders = Get-ChildItem -Path "dist" -Directory
        
        if ($distFolders.Count -eq 0) {
          echo "[ERROR] No folders found in dist!"
          echo "Checking for .exe files directly in dist:"
          Get-ChildItem -Path "dist" -Filter "*.exe"
          exit 1
        }
        
        $targetFolder = $distFolders[0].Name
        echo "[INFO] Using folder: $targetFolder"
        
        if (Test-Path "dist/$targetFolder") {
          echo "[OK] Creating ZIP from dist/$targetFolder"
          7z a -tzip "Sama-Inventory-System-${{ github.ref_name }}.zip" "dist/$targetFolder/*"
          
          # Check if ZIP was created successfully
          if (Test-Path "Sama-Inventory-System-${{ github.ref_name }}.zip") {
            $zipSize = (Get-Item "Sama-Inventory-System-${{ github.ref_name }}.zip").Length
            echo "[SUCCESS] ZIP created successfully - Size: $zipSize bytes"
          } else {
            echo "[ERROR] ZIP file was not created!"
            exit 1
          }
        } else {
          echo "[ERROR] Folder dist/$targetFolder not accessible!"
          exit 1
        }
        
    - name: Get Release Info
      id: release_info
      run: |
        if ("${{ github.ref_name }}" -match "^v(.+)$") {
          $version = $matches[1]
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "release_name=Sama Inventory System v$version" >> $env:GITHUB_OUTPUT
        }
        
    - name: Create Release and Upload Asset
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        name: ${{ steps.release_info.outputs.release_name }}
        body: |
          ğŸ‰ **Ù†Ø³Ø®Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Sama**
          
          ## âœ¨ Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:
          - ØªØ­Ø³ÙŠÙ†Ø§Øª ÙÙŠ Ø§Ù„Ø£Ø¯Ø§Ø¡
          - Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
          - Ù…ÙŠØ²Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
          
          ## ğŸ“¦ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ«Ø¨ÙŠØª:
          1. Ø­Ù…Ù„ Ø§Ù„Ù…Ù„Ù `Sama-Inventory-System-${{ github.ref_name }}.zip`
          2. Ø§Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª
          3. Ø´ØºÙ„ `Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.exe`
          
          ## ğŸ”„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:
          Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ Ù†Ø³Ø®Ø© Ø³Ø§Ø¨Ù‚Ø©ØŒ Ø³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø¥Ø´Ø¹Ø§Ø± ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬.
          
          ---
          Ø§Ù„Ø¥ØµØ¯Ø§Ø±: ${{ steps.release_info.outputs.version }}
          ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ù†Ø§Ø¡: ${{ github.event.head_commit.timestamp }}
        files: ./Sama-Inventory-System-${{ github.ref_name }}.zip
        draft: false
        prerelease: false
        
    # Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¨Ù†Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    - name: Notify Success
      if: success()
      run: |
        echo "âœ… ØªÙ… Ø¨Ù†Ø§Ø¡ ÙˆÙ†Ø´Ø± Ø§Ù„Ø¥ØµØ¯Ø§Ø± ${{ github.ref_name }} Ø¨Ù†Ø¬Ø§Ø­!"
        echo "ğŸ”— Ø§Ù„Ø±Ø§Ø¨Ø·: https://github.com/StrucTech/Sama-Inventory-System/releases/tag/${{ github.ref_name }}"